version: '3.0'

services:
  unit-blobstore-azure:
    build: { context: .github/actions/run-golang-unit-tests }
    volumes: [./src/azure-blobstore-backup-restore:/goproject]

  unit-blobstore-gcs:
    build: { context: .github/actions/run-golang-unit-tests }
    volumes: [./src/gcs-blobstore-backup-restore:/goproject]

  unit-blobstore-s3:
    build: { context: .github/actions/run-golang-unit-tests }
    volumes: [./src/s3-blobstore-backup-restore:/goproject]

  unit-database:
    build: { context: .github/actions/run-golang-unit-tests }
    volumes: [./src/database-backup-restore:/goproject]

  unit-sdk-template:
    build: { context: .github/actions/sdk-template-unit-tests }
    volumes: [.:/backup-and-restore-sdk-release]

  system-db-mysql:
    build:
      context: .github/actions/run-system-db-tests
      args:
      - MYSQL_VERSION=${MYSQL_VERSION}
    volumes:
    - ./:/backup-and-restore-sdk-release
    - mysql-certs:/mysql-certs
    depends_on: [system-db-mysql-backing-db]
    environment:
    - MYSQL_CA_CERT_PATH=/mysql-certs/ca.pem
    - MYSQL_CLIENT_CERT_PATH=/mysql-certs/server-cert.pem
    - MYSQL_CLIENT_KEY_PATH=/mysql-certs/server-key.pem
    - MYSQL_USERNAME=root
    - MYSQL_HOSTNAME=system-db-mysql-backing-db
    - MYSQL_PORT=3306
    - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    - TEST_TLS=true
    - TEST_TLS_VERIFY_IDENTITY=false
    - TEST_SSL_USER_REQUIRES_SSL=true

  system-db-mysql-backing-db:
    build:
      context: .github/actions/run-system-db-tests/mysql
      args:
      - MYSQL_VERSION=${MYSQL_VERSION}
    volumes:
    - mysql-certs:/mysql-certs
    environment:
    - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}

volumes:
# See https://docs.docker.com/compose/compose-file/#volumes - Specially:
### To reuse a volume across multiple services,
### a named volume MUST be declared in the top-level volumes key.
  mysql-certs:
